<UserControl x:Class="HouseholdMS.Controls.It8615Control"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
             xmlns:res="clr-namespace:HouseholdMS.Resources"
             mc:Ignorable="d"
             d:DesignHeight="900" d:DesignWidth="1300"
             MinWidth="820" MinHeight="560"
             FontFamily="Segoe UI" FontSize="13"
             SnapsToDevicePixels="True" UseLayoutRounding="True"
             TextOptions.TextFormattingMode="Display"
             TextOptions.TextRenderingMode="ClearType"
             RenderOptions.ClearTypeHint="Enabled">

    <!-- ======================= THEME / STYLES (mirrors MeasurementView) ======================= -->
    <UserControl.Resources>
        <!-- Palette -->
        <SolidColorBrush x:Key="PageBg"           Color="#F3F4F6"/>
        <SolidColorBrush x:Key="AccentBrush"      Color="#3B82F6"/>
        <SolidColorBrush x:Key="AccentBrushHover" Color="#2563EB"/>
        <SolidColorBrush x:Key="HeaderFg"         Color="#111827"/>
        <SolidColorBrush x:Key="BodyFg"           Color="#374151"/>
        <SolidColorBrush x:Key="SubtleFg"         Color="#6B7280"/>
        <SolidColorBrush x:Key="PassBrush"        Color="#10B981"/>
        <SolidColorBrush x:Key="FailBrush"        Color="#EF4444"/>

        <!-- Cards -->
        <SolidColorBrush x:Key="CardBg"     Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="CardBorder" Color="#E5E7EB"/>

        <Style x:Key="Card" TargetType="Border">
            <Setter Property="Padding" Value="14"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Background" Value="{StaticResource CardBg}"/>
            <Setter Property="BorderBrush" Value="{StaticResource CardBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <!-- Headings -->
        <Style x:Key="SectionTitle" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource HeaderFg}"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
        </Style>

        <!-- Primary Button -->
        <Style TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" Background="{TemplateBinding Background}" CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"
                                              RecognizesAccessKey="True"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="{StaticResource AccentBrushHover}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ToggleButton -->
        <Style TargetType="ToggleButton">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="#64748B"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="MinWidth" Value="110"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="bd" Background="{TemplateBinding Background}" CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="{StaticResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Opacity" Value="0.95"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Inputs -->
        <Style TargetType="ComboBox">
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="Height" Value="24"/>
        </Style>
        <Style TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="{StaticResource BodyFg}"/>
        </Style>
        <Style TargetType="GroupBox">
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Margin" Value="0,8,0,0"/>
        </Style>
        <Style TargetType="Expander">
            <Setter Property="Margin" Value="0,8,0,0"/>
        </Style>

        <!-- Existing control resources kept intact -->
        <x:Array x:Key="AcDcOptions" Type="{x:Type sys:String}">
            <sys:String>AC</sys:String>
            <sys:String>DC</sys:String>
        </x:Array>

        <!-- Keep it conservative for older SfChart versions -->
        <Style x:Key="MeterYAxisStyle" TargetType="syncfusion:NumericalAxis">
            <Setter Property="LabelFormat" Value="0.00"/>
            <Setter Property="OpposedPosition" Value="True"/>
            <Setter Property="ShowGridLines" Value="True"/>
        </Style>
    </UserControl.Resources>

    <!-- ======================= LAYOUT ======================= -->
    <Border Background="{StaticResource PageBg}" Padding="20">
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" SnapsToDevicePixels="True">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <DockPanel Grid.Row="0" Margin="0,0,0,14">
                    <StackPanel DockPanel.Dock="Left">
                        <TextBlock Text="{x:Static res:Strings.IT8615_Header_Title}" FontSize="22" FontWeight="Bold"
                                   Foreground="{StaticResource HeaderFg}"/>
                        <TextBlock Text="{x:Static res:Strings.IT8615_Header_Sub}" Foreground="{StaticResource SubtleFg}"/>
                    </StackPanel>
                </DockPanel>

                <!-- Connection / Top bar -->
                <Border Grid.Row="1" Style="{StaticResource Card}" Margin="0,0,0,14">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="4*"/>
                            <ColumnDefinition Width="3*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Left: resource + connect -->
                        <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Center">
                            <TextBlock Text="{x:Static res:Strings.IT8615_Conn_Resource}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <ComboBox x:Name="ResourceCombo" Width="320" Margin="0,0,6,0"/>
                            <Button x:Name="BtnRefresh" Content="{x:Static res:Strings.IT8615_Btn_Discover}" Click="BtnRefresh_Click" Margin="0,0,6,0"/>
                            <Button x:Name="BtnConnect" Content="{x:Static res:Strings.IT8615_Btn_Connect}" Click="BtnConnect_Click" Margin="0,0,6,0"/>
                            <Button x:Name="BtnDisconnect" Content="{x:Static res:Strings.IT8615_Btn_Disconnect}" Click="BtnDisconnect_Click"/>
                            <TextBlock Text="{x:Static res:Strings.IT8615_Conn_InstrumentId}" VerticalAlignment="Center" Margin="12,0,4,0" Foreground="{StaticResource SubtleFg}"/>
                            <TextBlock x:Name="TxtIdn" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Right: comms settings -->
                        <StackPanel Orientation="Horizontal" Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <TextBlock Text="{x:Static res:Strings.IT8615_Conn_Timeout}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBox x:Name="TxtTimeout" Width="80" Text="2000" Margin="0,0,10,0"/>
                            <TextBlock Text="{x:Static res:Strings.IT8615_Conn_Retry}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBox x:Name="TxtRetries" Width="50" Text="2"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Main Tabs -->
                <Border Grid.Row="2" Style="{StaticResource Card}">
                    <TabControl x:Name="MainTabs">
                        <!-- ====================== PARAMETERS ====================== -->
                        <TabItem Header="{x:Static res:Strings.IT8615_Tab_Parameters}">
                            <ScrollViewer>
                                <Grid Margin="6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="3*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- LEFT: Operating stack -->
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{x:Static res:Strings.IT8615_Param_OperatingMode}" Style="{StaticResource SectionTitle}" FontSize="16"/>
                                        <Border Style="{StaticResource Card}">
                                            <StackPanel Margin="2">
                                                <WrapPanel>
                                                    <TextBlock Text="{x:Static res:Strings.IT8615_Param_Acdc}"/>
                                                    <ComboBox x:Name="CboAcDc" Width="100" Margin="6,0,12,0"
                                                              ItemsSource="{StaticResource AcDcOptions}" SelectedIndex="0"/>
                                                    <TextBlock Text="{x:Static res:Strings.IT8615_Param_Function}"/>
                                                    <ComboBox x:Name="CboFunction" Width="220" Margin="6,0,0,0"
                                                              ToolTip="{x:Static res:Strings.IT8615_ModeTooltip}">
                                                        <ComboBoxItem Content="{x:Static res:Strings.IT8615_Func_Current}"    Tag="CURR"/>
                                                        <ComboBoxItem Content="{x:Static res:Strings.IT8615_Func_Resistance}" Tag="RES"/>
                                                        <ComboBoxItem Content="{x:Static res:Strings.IT8615_Func_Voltage}"    Tag="VOLT"/>
                                                        <ComboBoxItem Content="{x:Static res:Strings.IT8615_Func_Power}"      Tag="POW"/>
                                                        <ComboBoxItem Content="{x:Static res:Strings.IT8615_Func_Short}"      Tag="SHOR"/>
                                                    </ComboBox>
                                                </WrapPanel>

                                                <WrapPanel Margin="0,8,0,0">
                                                    <TextBlock Text="{x:Static res:Strings.IT8615_Param_Setpoint}"/>
                                                    <TextBox x:Name="TxtSetpoint" Width="120" Text="1.000"/>
                                                    <TextBlock x:Name="TxtSetpointUnits" Text="A" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                                    <Button x:Name="BtnApplySetpoint" Content="{x:Static res:Strings.IT8615_Btn_Apply}" Margin="0,0,12,0" Click="BtnApplySetpoint_Click"/>
                                                    <CheckBox x:Name="ChkEnable" Content="{x:Static res:Strings.IT8615_Param_EnableInput}" Click="ChkEnable_Click" VerticalAlignment="Center"/>
                                                </WrapPanel>

                                                <WrapPanel Margin="0,8,0,0">
                                                    <TextBlock Text="{x:Static res:Strings.IT8615_Param_PowerFactor}"/>
                                                    <TextBox x:Name="TxtPf" Width="80" Text="1.00" Margin="6,0,12,0"/>
                                                    <TextBlock Text="{x:Static res:Strings.IT8615_Param_CrestFactor}"/>
                                                    <TextBox x:Name="TxtCf" Width="80" Text="1.41" Margin="6,0,12,0"/>
                                                    <Button x:Name="BtnApplyPfCf" Content="{x:Static res:Strings.IT8615_Btn_ApplyPfCf}" Click="BtnApplyPfCf_Click"/>
                                                </WrapPanel>

                                                <WrapPanel Margin="0,8,0,0">
                                                    <Button x:Name="BtnStart" Content="{x:Static res:Strings.IT8615_Btn_Start}" Width="120" Click="BtnStart_Click" Margin="0,0,6,0"/>
                                                    <Button x:Name="BtnStop" Content="{x:Static res:Strings.IT8615_Btn_Stop}" Width="120" Click="BtnStop_Click" Margin="0,0,6,0"/>
                                                    <Button x:Name="BtnEStop" Content="{x:Static res:Strings.IT8615_Btn_EStop}" Background="Tomato" Foreground="White" Click="BtnEStop_Click"/>
                                                </WrapPanel>

                                                <TextBlock x:Name="TxtLimits" TextWrapping="Wrap" Foreground="{StaticResource SubtleFg}" Margin="0,8,0,0"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>

                                    <!-- RIGHT: Meter panel with tiny charts -->
                                    <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                        <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Title}" Style="{StaticResource SectionTitle}" FontSize="16"/>
                                        <Border Style="{StaticResource Card}">
                                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                                <StackPanel Margin="8">

                                                    <!-- Voltage RMS -->
                                                    <StackPanel Margin="0,0,0,10">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Vrms}"/>
                                                            <TextBlock x:Name="ValVrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding VrmsHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                    <!-- Current RMS -->
                                                    <StackPanel Margin="0,0,0,10">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Irms}"/>
                                                            <TextBlock x:Name="ValIrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding IrmsHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                    <!-- Power -->
                                                    <StackPanel Margin="0,0,0,10">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Power}"/>
                                                            <TextBlock x:Name="ValPower" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding PowerHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                    <!-- Power Factor -->
                                                    <StackPanel Margin="0,0,0,10">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Pf}"/>
                                                            <TextBlock x:Name="ValPf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}" LabelFormat="0.000"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding PfHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                    <!-- Frequency -->
                                                    <StackPanel Margin="0,0,0,10">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Freq}"/>
                                                            <TextBlock x:Name="ValFreq" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding FreqHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                    <!-- Crest Factor -->
                                                    <StackPanel Margin="0,0,0,6">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{x:Static res:Strings.IT8615_Meter_Cf}"/>
                                                            <TextBlock x:Name="ValCf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                                        </StackPanel>
                                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                                            <syncfusion:SfChart.PrimaryAxis>
                                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                                            </syncfusion:SfChart.PrimaryAxis>
                                                            <syncfusion:SfChart.SecondaryAxis>
                                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                                            </syncfusion:SfChart.SecondaryAxis>
                                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                                   ItemsSource="{Binding CfHistory}"
                                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                                        </syncfusion:SfChart>
                                                    </StackPanel>

                                                </StackPanel>
                                            </ScrollViewer>
                                        </Border>
                                    </StackPanel>
                                </Grid>
                            </ScrollViewer>
                        </TabItem>

                        <!-- ====================== SCOPE ====================== -->
                        <TabItem Header="{x:Static res:Strings.IT8615_Tab_Scope}">
                            <Grid Margin="10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Top: Run/Single/Stop + Time/Div -->
                                <Border Style="{StaticResource Card}" Grid.Row="0">
                                    <WrapPanel>
                                        <Button Content="{x:Static res:Strings.IT8615_Btn_Run}" Click="BtnScopeRun_Click" Margin="0,0,6,0"/>
                                        <Button Content="{x:Static res:Strings.IT8615_Btn_Single}" Click="BtnScopeSingle_Click" Margin="0,0,6,0"/>
                                        <Button Content="{x:Static res:Strings.IT8615_Btn_Stop}" Click="BtnScopeStop_Click" Margin="0,0,12,0"/>

                                        <TextBlock Text="{x:Static res:Strings.IT8615_Label_TimeDiv}" VerticalAlignment="Center"/>
                                        <ComboBox x:Name="CboDivTime" Width="90" Margin="6,0,12,0">
                                            <ComboBoxItem Content="0.0005"/>
                                            <ComboBoxItem Content="0.001"/>
                                            <ComboBoxItem Content="0.002"/>
                                            <ComboBoxItem Content="0.005"/>
                                            <ComboBoxItem Content="0.01"/>
                                            <ComboBoxItem Content="0.02"/>
                                            <ComboBoxItem Content="0.05"/>
                                            <ComboBoxItem Content="0.1"/>
                                            <ComboBoxItem Content="0.2"/>
                                        </ComboBox>
                                        <Button Content="{x:Static res:Strings.IT8615_Btn_ApplyTimeDiv}" Width="120" Click="BtnApplyDivTime_Click"/>
                                    </WrapPanel>
                                </Border>

                                <!-- Middle: Trigger / Vertical / Knob -->
                                <Grid Grid.Row="1" Margin="0,8,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="2*"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Style="{StaticResource Card}" Grid.Column="0" Margin="0,0,8,0">
                                        <StackPanel>
                                            <TextBlock Text="{x:Static res:Strings.IT8615_Trig_Title}" Style="{StaticResource SectionTitle}"/>
                                            <WrapPanel Margin="0,0,0,6">
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Trig_Source}" VerticalAlignment="Center"/>
                                                <ComboBox x:Name="CboTrigSource" Width="120" Margin="6,0,12,0">
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigSrc_Voltage}" Tag="VOLTage"/>
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigSrc_Current}" Tag="CURRent"/>
                                                </ComboBox>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Trig_Slope}" VerticalAlignment="Center"/>
                                                <ComboBox x:Name="CboTrigSlope" Width="120" Margin="6,0,12,0">
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigSlope_Pos}" Tag="POSitive"/>
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigSlope_Neg}" Tag="NEGative"/>
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigSlope_Any}" Tag="ANY"/>
                                                </ComboBox>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Trig_Mode}" VerticalAlignment="Center"/>
                                                <ComboBox x:Name="CboTrigMode" Width="120" Margin="0,6,12,0">
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigMode_Auto}" Tag="AUTO"/>
                                                    <ComboBoxItem Content="{x:Static res:Strings.IT8615_TrigMode_Norm}" Tag="NORMal"/>
                                                </ComboBox>
                                            </WrapPanel>
                                            <WrapPanel>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Trig_Level}" VerticalAlignment="Center"/>
                                                <TextBox x:Name="TxtTrigLevel" Width="80" Margin="6,0,12,0" Text="10"/>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Trig_DelaySec}" VerticalAlignment="Center"/>
                                                <TextBox x:Name="TxtTrigDelay" Width="80" Margin="6,0,12,0" Text="0.0"/>
                                                <Button Content="{x:Static res:Strings.IT8615_Btn_ApplyTrigger}" Width="120" Click="BtnApplyTrigger_Click" Margin="0,6,12,0"/>
                                                <TextBlock x:Name="TxtTrigState" Margin="12,0,0,0" VerticalAlignment="Center" Foreground="{StaticResource SubtleFg}"/>
                                            </WrapPanel>
                                        </StackPanel>
                                    </Border>

                                    <Border Style="{StaticResource Card}" Grid.Column="1" Margin="0,0,8,0">
                                        <StackPanel>
                                            <TextBlock Text="{x:Static res:Strings.IT8615_Vert_Title}" Style="{StaticResource SectionTitle}"/>
                                            <WrapPanel Margin="0,0,0,6">
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_VBase}"/>
                                                <TextBox x:Name="TxtVBase" Width="80" Margin="6,0,12,0" Text="0"/>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_VRange}"/>
                                                <TextBox x:Name="TxtVRange" Width="80" Margin="6,0,12,0" Text="260"/>
                                            </WrapPanel>
                                            <WrapPanel Margin="0,0,0,6">
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_ABase}"/>
                                                <TextBox x:Name="TxtABase" Width="80" Margin="6,0,12,0" Text="0"/>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_ARange}"/>
                                                <TextBox x:Name="TxtARange" Width="80" Margin="6,0,12,0" Text="20"/>
                                            </WrapPanel>
                                            <WrapPanel Margin="0,0,0,6">
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_Display}"/>
                                                <ComboBox x:Name="CboScopeSel" Width="90" Margin="6,0,12,0">
                                                    <ComboBoxItem Content="U"/>
                                                    <ComboBoxItem Content="A"/>
                                                    <ComboBoxItem Content="UA"/>
                                                </ComboBox>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Vert_Average}"/>
                                                <TextBox x:Name="TxtAvgCount" Width="60" Margin="6,0,12,0" Text="4"/>
                                            </WrapPanel>
                                            <WrapPanel>
                                                <Button Content="{x:Static res:Strings.IT8615_Btn_ApplyVertical}" Width="120" Margin="0,0,6,0" Click="BtnApplyVertical_Click"/>
                                                <Button Content="{x:Static res:Strings.IT8615_Btn_ApplyDisplayAvg}" Width="160" Click="BtnApplyDisplayAndAverage_Click"/>
                                            </WrapPanel>
                                        </StackPanel>
                                    </Border>

                                    <Border Style="{StaticResource Card}" Grid.Column="2">
                                        <StackPanel>
                                            <TextBlock Text="{x:Static res:Strings.IT8615_Knob_Title}" Style="{StaticResource SectionTitle}"/>
                                            <WrapPanel>
                                                <TextBlock Text="{x:Static res:Strings.IT8615_Knob_Label}" VerticalAlignment="Center"/>
                                                <!-- ItemsSource will be set in code-behind with localized strings, preserving token prefix -->
                                                <ComboBox x:Name="CboKnob" Width="220" Margin="6,0,12,0" SelectedIndex="0"/>
                                                <Button Content="{x:Static res:Strings.IT8615_Btn_ApplyKnob}" Width="120" Click="BtnApplyKnob_Click"/>
                                            </WrapPanel>
                                            <TextBlock Foreground="{StaticResource SubtleFg}"
                                                       Text="{x:Static res:Strings.IT8615_Knob_Help}"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>

                                <!-- Big scope chart -->
                                <Border Style="{StaticResource Card}" Grid.Row="2">
                                    <syncfusion:SfChart x:Name="ScopeChart">
                                        <syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:NumericalAxis Header="{x:Static res:Strings.IT8615_Scope_AxisX}"/>
                                        </syncfusion:SfChart.PrimaryAxis>
                                        <syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:NumericalAxis Header="{x:Static res:Strings.IT8615_Scope_AxisY}" LabelFormat="0.00"/>
                                        </syncfusion:SfChart.SecondaryAxis>

                                        <syncfusion:LineSeries x:Name="SeriesV"
                                                               ItemsSource="{Binding ScopeV}"
                                                               XBindingPath="Index"
                                                               YBindingPath="Value"
                                                               Label="{x:Static res:Strings.IT8615_Scope_SeriesVolt}"/>
                                        <syncfusion:LineSeries x:Name="SeriesI"
                                                               ItemsSource="{Binding ScopeI}"
                                                               XBindingPath="Index"
                                                               YBindingPath="Value"
                                                               Label="{x:Static res:Strings.IT8615_Scope_SeriesCurr}"/>
                                    </syncfusion:SfChart>
                                </Border>
                            </Grid>
                        </TabItem>

                        <!-- ====================== HARMONICS ====================== -->
                        <TabItem Header="{x:Static res:Strings.IT8615_Tab_Harmonics}">
                            <Grid Margin="10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <Border Style="{StaticResource Card}" Grid.Row="0">
                                    <WrapPanel>
                                        <Button Content="{x:Static res:Strings.IT8615_Harm_BtnMeasure}" Click="BtnMeasureHarmonics_Click" Margin="0,0,12,0"/>
                                        <TextBlock Text="{x:Static res:Strings.IT8615_Harm_UpToN}" VerticalAlignment="Center"/>
                                        <TextBox x:Name="TxtHarmonicsN" Width="60" Text="50" Margin="6,0,0,0"/>
                                    </WrapPanel>
                                </Border>

                                <Border Style="{StaticResource Card}" Grid.Row="1" Margin="0,8,0,0">
                                    <syncfusion:SfChart x:Name="HarmonicsChart">
                                        <syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:CategoryAxis Header="{x:Static res:Strings.IT8615_Harm_AxisX}"/>
                                        </syncfusion:SfChart.PrimaryAxis>
                                        <syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:NumericalAxis Header="{x:Static res:Strings.IT8615_Harm_AxisY}" LabelFormat="0.00"/>
                                        </syncfusion:SfChart.SecondaryAxis>

                                        <syncfusion:ColumnSeries x:Name="SeriesHarm"
                                                                 ItemsSource="{Binding Harmonics}"
                                                                 XBindingPath="Index"
                                                                 YBindingPath="Value"
                                                                 Label="{x:Static res:Strings.IT8615_Harm_SeriesLabel}"/>
                                    </syncfusion:SfChart>
                                </Border>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Border>

                <!-- Status -->
                <Border Grid.Row="3" Style="{StaticResource Card}" Margin="0,14,0,0">
                    <StatusBar Background="Transparent" BorderThickness="0">
                        <StatusBarItem>
                            <TextBlock x:Name="TxtStatus" Text="{x:Static res:Strings.IT8615_Status_Idle}"/>
                        </StatusBarItem>
                    </StatusBar>
                </Border>
            </Grid>
        </ScrollViewer>
    </Border>
</UserControl>
