<!-- It8615Control.xaml (Logger tab removed) -->
<UserControl x:Class="HouseholdMS.Controls.It8615Control"       
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
             mc:Ignorable="d" d:DesignHeight="900" d:DesignWidth="1300">

    <UserControl.Resources>
        <x:Array x:Key="AcDcOptions" Type="{x:Type sys:String}">
            <sys:String>AC</sys:String>
            <sys:String>DC</sys:String>
        </x:Array>

        <!-- Keep it conservative for older SfChart versions -->
        <Style x:Key="MeterYAxisStyle" TargetType="syncfusion:NumericalAxis">
            <Setter Property="LabelFormat" Value="0.00"/>
            <Setter Property="OpposedPosition" Value="True"/>
            <Setter Property="ShowGridLines" Value="True"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top bar -->
        <DockPanel Margin="8">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <Label Content="Resource:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <ComboBox x:Name="ResourceCombo" Width="320" Margin="0,0,6,0"/>
                <Button x:Name="BtnRefresh" Content="Discover" Click="BtnRefresh_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnConnect" Content="Connect" Click="BtnConnect_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnDisconnect" Content="Disconnect" Click="BtnDisconnect_Click"/>
                <TextBlock Text="   Instrument ID:" VerticalAlignment="Center" Margin="12,0,4,0"/>
                <TextBlock x:Name="TxtIdn" FontWeight="Bold" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <TextBlock Text="Timeout (milliseconds)" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtTimeout" Width="80" Text="2000" Margin="0,0,10,0"/>
                <TextBlock Text="Retry Count" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtRetries" Width="50" Text="2"/>
            </StackPanel>
        </DockPanel>

        <!-- Body -->
        <TabControl Grid.Row="1" x:Name="MainTabs">
            <!-- Parameters -->
            <TabItem Header="Parameters">
                <ScrollViewer>
                    <Grid Margin="10">
                        <!-- two columns only: left stack (Operating) + Meter -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="3*"/>
                        </Grid.ColumnDefinitions>

                        <!-- LEFT COLUMN: stack -->
                        <StackPanel Grid.Column="0">
                            <GroupBox Header="Operating Mode" Margin="4">
                                <StackPanel Margin="8">
                                    <WrapPanel>
                                        <Label Content="AC / DC:"/>
                                        <ComboBox x:Name="CboAcDc" Width="100" Margin="6,0,12,0"
                                                  ItemsSource="{StaticResource AcDcOptions}" SelectedIndex="0"/>
                                        <Label Content="Function:"/>
                                        <!-- Friendly text in Content; exact SCPI token in Tag -->
                                        <ComboBox x:Name="CboFunction" Width="200" Margin="6,0,0,0"
                                                  ToolTip="Modes: Constant Current, Constant Resistance, Constant Voltage, Constant Power, Short Circuit">
                                            <ComboBoxItem Content="Current (Constant Current)"    Tag="CURR"/>
                                            <ComboBoxItem Content="Resistance (Constant Resistance)" Tag="RES"/>
                                            <ComboBoxItem Content="Voltage (Constant Voltage)"    Tag="VOLT"/>
                                            <ComboBoxItem Content="Power (Constant Power)"        Tag="POW"/>
                                            <ComboBoxItem Content="Short Circuit"                 Tag="SHOR"/>
                                        </ComboBox>
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Label Content="Setpoint:"/>
                                        <TextBox x:Name="TxtSetpoint" Width="120" Text="1.000" Height="23"/>
                                        <TextBlock x:Name="TxtSetpointUnits" Text="A" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                        <Button x:Name="BtnApplySetpoint" Content="Apply" Margin="0,0,12,0" Click="BtnApplySetpoint_Click"/>
                                        <CheckBox x:Name="ChkEnable" Content="Enable Input" Click="ChkEnable_Click" />
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Label Content="Power Factor:"/>
                                        <TextBox x:Name="TxtPf" Width="80" Text="1.00" Margin="6,0,12,0" Height="23"/>
                                        <Label Content="Crest Factor:"/>
                                        <TextBox x:Name="TxtCf" Width="80" Text="1.41" Margin="6,0,12,0" Height="23"/>
                                        <Button x:Name="BtnApplyPfCf" Content="Apply Power Factor / Crest Factor" Click="BtnApplyPfCf_Click"/>
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Button x:Name="BtnStart" Content="Start" Width="120" Click="BtnStart_Click" Margin="0,0,6,0"/>
                                        <Button x:Name="BtnStop" Content="Stop" Width="120" Click="BtnStop_Click" Margin="0,0,6,0"/>
                                        <Button x:Name="BtnEStop" Content="Emergency Stop" Background="Tomato" Foreground="White" Click="BtnEStop_Click"/>
                                    </WrapPanel>

                                    <TextBlock x:Name="TxtLimits" TextWrapping="Wrap" Foreground="Gray" Margin="0,6,0,0"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <!-- RIGHT COLUMN: Meter panel with tiny charts -->
                        <GroupBox Header="Meter (Live)" Grid.Column="1" Margin="4">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="8">

                                    <!-- Voltage RMS -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Voltage RMS:"/>
                                            <TextBlock x:Name="ValVrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding VrmsHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Current RMS -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Current RMS:"/>
                                            <TextBlock x:Name="ValIrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding IrmsHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Power -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Power:"/>
                                            <TextBlock x:Name="ValPower" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding PowerHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Power Factor -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Power Factor:"/>
                                            <TextBlock x:Name="ValPf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}" LabelFormat="0.000"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding PfHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Frequency -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Frequency:"/>
                                            <TextBlock x:Name="ValFreq" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding FreqHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Crest Factor -->
                                    <StackPanel Margin="0,0,0,6">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Crest Factor:"/>
                                            <TextBlock x:Name="ValCf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding CfHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </GroupBox>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- ====================== SCOPE (UPDATED) ====================== -->
            <TabItem Header="Scope">
                <Grid Margin="6">
                    <Grid.Resources>
                        <x:Array x:Key="TrigSources" Type="{x:Type sys:String}">
                            <sys:String>VOLTage</sys:String>
                            <sys:String>CURRent</sys:String>
                        </x:Array>
                        <x:Array x:Key="TrigSlopes" Type="{x:Type sys:String}">
                            <sys:String>POSitive</sys:String>
                            <sys:String>NEGative</sys:String>
                            <sys:String>ANY</sys:String>
                        </x:Array>
                        <x:Array x:Key="TrigModes" Type="{x:Type sys:String}">
                            <sys:String>AUTO</sys:String>
                            <sys:String>NORMal</sys:String>
                        </x:Array>
                        <x:Array x:Key="ScopeSelections" Type="{x:Type sys:String}">
                            <sys:String>U</sys:String>
                            <sys:String>A</sys:String>
                            <sys:String>UA</sys:String>
                        </x:Array>
                        <x:Array x:Key="KnobOptions" Type="{x:Type sys:String}">
                            <sys:String>UR (Volt Range)</sys:String>
                            <sys:String>AR (Curr Range)</sys:String>
                            <sys:String>UB (Volt Base)</sys:String>
                            <sys:String>AB (Curr Base)</sys:String>
                            <sys:String>TL (Trig Level)</sys:String>
                            <sys:String>TD (Trig Delay)</sys:String>
                            <sys:String>T/d (Time/Div)</sys:String>
                        </x:Array>
                        <x:Array x:Key="DivTimes" Type="{x:Type sys:String}">
                            <sys:String>0.0005</sys:String>
                            <sys:String>0.001</sys:String>
                            <sys:String>0.002</sys:String>
                            <sys:String>0.005</sys:String>
                            <sys:String>0.01</sys:String>
                            <sys:String>0.02</sys:String>
                            <sys:String>0.05</sys:String>
                            <sys:String>0.1</sys:String>
                            <sys:String>0.2</sys:String>
                        </x:Array>
                    </Grid.Resources>

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Top: run/single/stop + time/div -->
                    <WrapPanel Grid.Row="0" Margin="0,0,0,6">
                        <Button Content="Run" Click="BtnScopeRun_Click" Margin="0,0,6,0"/>
                        <Button Content="Single" Click="BtnScopeSingle_Click" Margin="0,0,6,0"/>
                        <Button Content="Stop" Click="BtnScopeStop_Click" Margin="0,0,12,0"/>

                        <TextBlock Text="Time/Div (s)" VerticalAlignment="Center"/>
                        <ComboBox x:Name="CboDivTime" Width="90" Margin="6,0,12,0" ItemsSource="{StaticResource DivTimes}" SelectedIndex="3"/>
                        <Button Content="Apply Time/Div" Width="120" Click="BtnApplyDivTime_Click"/>
                    </WrapPanel>

                    <!-- Middle: trigger / vertical / measure / knob -->
                    <Grid Grid.Row="1" Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Trigger -->
                        <GroupBox Header="Trigger Setup" Grid.Column="0" Margin="0,0,6,0">
                            <StackPanel Margin="10,6">
                                <WrapPanel Margin="0,0,0,6">
                                    <TextBlock Text="Source" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="CboTrigSource" Width="110" Margin="6,0,12,0" ItemsSource="{StaticResource TrigSources}" SelectedIndex="0"/>
                                    <TextBlock Text="Slope" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="CboTrigSlope" Width="110" Margin="6,0,12,0" ItemsSource="{StaticResource TrigSlopes}" SelectedIndex="0"/>
                                    <TextBlock Text="Mode" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="CboTrigMode" Width="110" Margin="0,6,12,0" ItemsSource="{StaticResource TrigModes}" SelectedIndex="0"/>
                                </WrapPanel>

                                <WrapPanel>
                                    <TextBlock Text="Level" VerticalAlignment="Center"/>
                                    <TextBox x:Name="TxtTrigLevel" Width="80" Margin="6,0,12,0" Text="10"/>
                                    <TextBlock Text="Delay (s)" VerticalAlignment="Center"/>
                                    <TextBox x:Name="TxtTrigDelay" Width="80" Margin="6,0,12,0" Text="0.0"/>
                                    <Button Content="Apply Trigger" Width="120" Click="BtnApplyTrigger_Click" Margin="0,6,12,0"/>
                                    <TextBlock x:Name="TxtTrigState" Margin="12,0,0,0" VerticalAlignment="Center" Foreground="Gray"/>
                                </WrapPanel>
                            </StackPanel>
                        </GroupBox>

                        <!-- Vertical / Display / Average -->
                        <GroupBox Header="Vertical / Measure" Grid.Column="1" Margin="0,0,6,0">
                            <StackPanel Margin="10,6">
                                <WrapPanel Margin="0,0,0,6">
                                    <TextBlock Text="V Base (V)"/>
                                    <TextBox x:Name="TxtVBase" Width="80" Margin="6,0,12,0" Text="0"/>
                                    <TextBlock Text="V Range (V)"/>
                                    <TextBox x:Name="TxtVRange" Width="80" Margin="6,0,12,0" Text="260"/>
                                </WrapPanel>
                                <WrapPanel Margin="0,0,0,6">
                                    <TextBlock Text="A Base (A)"/>
                                    <TextBox x:Name="TxtABase" Width="80" Margin="6,0,12,0" Text="0"/>
                                    <TextBlock Text="A Range (A)"/>
                                    <TextBox x:Name="TxtARange" Width="80" Margin="6,0,12,0" Text="20"/>
                                </WrapPanel>
                                <WrapPanel Margin="0,0,0,6">
                                    <TextBlock Text="Display"/>
                                    <ComboBox x:Name="CboScopeSel" Width="90" Margin="6,0,12,0" ItemsSource="{StaticResource ScopeSelections}" SelectedIndex="2"/>
                                    <TextBlock Text="Average (1-16)"/>
                                    <TextBox x:Name="TxtAvgCount" Width="60" Margin="6,0,12,0" Text="4"/>
                                </WrapPanel>
                                <WrapPanel>
                                    <Button Content="Apply Vertical" Width="120" Margin="0,0,6,0" Click="BtnApplyVertical_Click"/>
                                    <Button Content="Apply Display/Average" Width="160" Click="BtnApplyDisplayAndAverage_Click"/>
                                </WrapPanel>
                            </StackPanel>
                        </GroupBox>

                        <!-- Knob mapping -->
                        <GroupBox Header="Knob Function" Grid.Column="2">
                            <StackPanel Margin="10,6">
                                <WrapPanel>
                                    <TextBlock Text="Knob maps to" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="CboKnob" Width="200" Margin="6,0,12,0" ItemsSource="{StaticResource KnobOptions}" SelectedIndex="0"/>
                                    <Button Content="Apply Knob" Width="120" Click="BtnApplyKnob_Click"/>
                                </WrapPanel>
                                <TextBlock Foreground="Gray" Text="UR/AR(change range), UB/AB(change base), TL(trigger level), TD(trigger delay), T/d(time per division)"/>
                            </StackPanel>
                        </GroupBox>
                    </Grid>

                    <!-- Big scope chart -->
                    <syncfusion:SfChart x:Name="ScopeChart" Grid.Row="2">
                        <syncfusion:SfChart.PrimaryAxis>
                            <syncfusion:NumericalAxis Header="Sample"/>
                        </syncfusion:SfChart.PrimaryAxis>
                        <syncfusion:SfChart.SecondaryAxis>
                            <syncfusion:NumericalAxis Header="V / A" LabelFormat="0.00"/>
                        </syncfusion:SfChart.SecondaryAxis>

                        <syncfusion:LineSeries x:Name="SeriesV"
                                               ItemsSource="{Binding ScopeV}"
                                               XBindingPath="Index"
                                               YBindingPath="Value"
                                               Label="Voltage"/>
                        <syncfusion:LineSeries x:Name="SeriesI"
                                               ItemsSource="{Binding ScopeI}"
                                               XBindingPath="Index"
                                               YBindingPath="Value"
                                               Label="Current"/>
                    </syncfusion:SfChart>
                </Grid>
            </TabItem>

            <!-- Harmonics -->
            <TabItem Header="Harmonics">
                <Grid Margin="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel>
                        <Button Content="Measure Harmonics" Click="BtnMeasureHarmonics_Click" Margin="0,0,12,0"/>
                        <Label Content="Up to Harmonic Number:" VerticalAlignment="Center"/>
                        <TextBox x:Name="TxtHarmonicsN" Width="60" Text="50" Margin="6,0,0,0"/>
                    </WrapPanel>

                    <syncfusion:SfChart x:Name="HarmonicsChart" Grid.Row="1">
                        <syncfusion:SfChart.PrimaryAxis>
                            <syncfusion:CategoryAxis Header="Harmonic Order (n)"/>
                        </syncfusion:SfChart.PrimaryAxis>
                        <syncfusion:SfChart.SecondaryAxis>
                            <syncfusion:NumericalAxis Header="Amplitude (normalized)" LabelFormat="0.00"/>
                        </syncfusion:SfChart.SecondaryAxis>

                        <syncfusion:ColumnSeries x:Name="SeriesHarm"
                                                 ItemsSource="{Binding Harmonics}"
                                                 XBindingPath="Index"
                                                 YBindingPath="Value"
                                                 Label="Voltage Harmonics"/>
                    </syncfusion:SfChart>
                </Grid>
            </TabItem>
        </TabControl>

        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock x:Name="TxtStatus" Text="Idle"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>
