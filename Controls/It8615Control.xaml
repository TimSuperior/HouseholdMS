<UserControl x:Class="HouseholdMS.Controls.It8615Control"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:chart="clr-namespace:Syncfusion.UI.Xaml.Charts;assembly=Syncfusion.SfChart.WPF"
             mc:Ignorable="d" d:DesignHeight="900" d:DesignWidth="1300">

    <UserControl.Resources>
        <x:Array x:Key="AcDcOptions" Type="{x:Type sys:String}">
            <sys:String>AC</sys:String>
            <sys:String>DC</sys:String>
        </x:Array>
        <x:Array x:Key="FuncOptions" Type="{x:Type sys:String}">
            <sys:String>CURR</sys:String>
            <sys:String>RES</sys:String>
            <sys:String>VOLT</sys:String>
            <sys:String>POW</sys:String>
            <sys:String>SHOR</sys:String>
        </x:Array>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top bar -->
        <DockPanel Margin="8">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <Label Content="Resource:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <ComboBox x:Name="ResourceCombo" Width="320" Margin="0,0,6,0"/>
                <Button x:Name="BtnRefresh" Content="Discover" Click="BtnRefresh_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnConnect" Content="Connect" Click="BtnConnect_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnDisconnect" Content="Disconnect" Click="BtnDisconnect_Click"/>
                <TextBlock Text="   IDN:" VerticalAlignment="Center" Margin="12,0,4,0"/>
                <TextBlock x:Name="TxtIdn" FontWeight="Bold" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <TextBlock Text="Timeout(ms)" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtTimeout" Width="80" Text="2000" Margin="0,0,10,0"/>
                <TextBlock Text="Retries" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtRetries" Width="50" Text="2"/>
            </StackPanel>
        </DockPanel>

        <!-- Body -->
        <TabControl Grid.Row="1" x:Name="MainTabs">
            <!-- Parameters -->
            <TabItem Header="Parameters">
                <ScrollViewer>
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <GroupBox Header="Operating Mode" Margin="4">
                            <StackPanel Margin="8">
                                <WrapPanel>
                                    <Label Content="AC/DC:"/>
                                    <ComboBox x:Name="CboAcDc" Width="100" Margin="6,0,12,0"
                                              ItemsSource="{StaticResource AcDcOptions}" SelectedIndex="0"/>
                                    <Label Content="Function:"/>
                                    <ComboBox x:Name="CboFunction" Width="150" Margin="6,0,0,0"
                                              ItemsSource="{StaticResource FuncOptions}" SelectedIndex="0"
                                              ToolTip="CC=CURR, CR=RES, CV=VOLT, CP=POW, SHORT=SHOR"/>
                                </WrapPanel>

                                <WrapPanel Margin="0,6,0,0">
                                    <Label Content="Setpoint:"/>
                                    <TextBox x:Name="TxtSetpoint" Width="120" Text="1.000" Margin="6,0,6,0"/>
                                    <TextBlock x:Name="TxtSetpointUnits" Text="A" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                    <Button x:Name="BtnApplySetpoint" Content="Apply" Margin="0,0,12,0" Click="BtnApplySetpoint_Click"/>
                                    <CheckBox x:Name="ChkEnable" Content="Input Enable" Click="ChkEnable_Click" />
                                </WrapPanel>

                                <WrapPanel Margin="0,6,0,0">
                                    <Label Content="PF:"/>
                                    <TextBox x:Name="TxtPf" Width="80" Text="1.00" Margin="6,0,12,0"/>
                                    <Label Content="CF:"/>
                                    <TextBox x:Name="TxtCf" Width="80" Text="1.41" Margin="6,0,12,0"/>
                                    <Button x:Name="BtnApplyPfCf" Content="Apply PF/CF" Click="BtnApplyPfCf_Click"/>
                                </WrapPanel>

                                <WrapPanel Margin="0,6,0,0">
                                    <Button x:Name="BtnStart" Content="Start" Width="120" Click="BtnStart_Click" Margin="0,0,6,0"/>
                                    <Button x:Name="BtnStop" Content="Stop" Width="120" Click="BtnStop_Click" Margin="0,0,6,0"/>
                                    <Button x:Name="BtnEStop" Content="E-STOP" Background="Tomato" Foreground="White" Click="BtnEStop_Click"/>
                                </WrapPanel>

                                <TextBlock x:Name="TxtLimits" TextWrapping="Wrap" Foreground="Gray" Margin="0,6,0,0"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Meter panel with tiny charts -->
                        <GroupBox Header="Meter (Live)" Grid.Column="1" Margin="4">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="8">
                                    <!-- Vrms -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Vrms:"/>
                                            <TextBlock x:Name="ValVrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding VrmsHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>

                                    <!-- Irms -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Irms:"/>
                                            <TextBlock x:Name="ValIrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding IrmsHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>

                                    <!-- Power -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Power:"/>
                                            <TextBlock x:Name="ValPower" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding PowerHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>

                                    <!-- PF -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="PF:"/>
                                            <TextBlock x:Name="ValPf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding PfHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>

                                    <!-- Freq -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Freq:"/>
                                            <TextBlock x:Name="ValFreq" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding FreqHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>

                                    <!-- Crest Factor -->
                                    <StackPanel Margin="0,0,0,6">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="CrestF:"/>
                                            <TextBlock x:Name="ValCf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <chart:SfChart Height="70" Margin="0,4,0,0">
                                            <chart:SfChart.PrimaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.PrimaryAxis>
                                            <chart:SfChart.SecondaryAxis>
                                                <chart:NumericalAxis Visibility="Collapsed"/>
                                            </chart:SfChart.SecondaryAxis>
                                            <chart:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                              ItemsSource="{Binding CfHistory}"
                                                              XBindingPath="Index" YBindingPath="Value"/>
                                        </chart:SfChart>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </GroupBox>

                        <GroupBox Header="Settings and Results" Grid.Column="2" Margin="4">
                            <StackPanel Margin="8">
                                <Button Content="Save Settings (JSON)" Click="BtnSaveSettings_Click" Margin="0,0,0,6"/>
                                <Button Content="Load Settings (JSON)" Click="BtnLoadSettings_Click" Margin="0,0,0,6"/>
                                <Button Content="Export Last Capture (CSV)" Click="BtnExportCsv_Click" Margin="0,0,0,6"/>
                                <Button Content="Generate Report (PDF)" Click="BtnReport_Click"/>
                            </StackPanel>
                        </GroupBox>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Scope -->
            <TabItem Header="Scope">
                <Grid Margin="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel>
                        <Button Content="Run" Click="BtnScopeRun_Click" Margin="0,0,6,0"/>
                        <Button Content="Single" Click="BtnScopeSingle_Click" Margin="0,0,6,0"/>
                        <Button Content="Stop" Click="BtnScopeStop_Click" Margin="0,0,12,0"/>
                        <Label Content="Trig Source" VerticalAlignment="Center"/>
                        <ComboBox x:Name="CboTrigSource" Width="100" Margin="6,0,12,0">
                            <ComboBoxItem Content="VOLTage"/>
                            <ComboBoxItem Content="CURRent"/>
                        </ComboBox>
                        <Label Content="Trig Slope" VerticalAlignment="Center"/>
                        <ComboBox x:Name="CboTrigSlope" Width="100" Margin="6,0,12,0">
                            <ComboBoxItem Content="POSitive"/>
                            <ComboBoxItem Content="NEGative"/>
                            <ComboBoxItem Content="ANY"/>
                        </ComboBox>
                        <Label Content="Trig Level" VerticalAlignment="Center"/>
                        <TextBox x:Name="TxtTrigLevel" Width="80" Text="10" Margin="6,0,0,0"/>
                    </WrapPanel>

                    <!-- Big scope chart -->
                    <chart:SfChart x:Name="ScopeChart" Grid.Row="1">
                        <chart:SfChart.PrimaryAxis>
                            <chart:NumericalAxis Header="Sample"/>
                        </chart:SfChart.PrimaryAxis>
                        <chart:SfChart.SecondaryAxis>
                            <chart:NumericalAxis Header="V / A"/>
                        </chart:SfChart.SecondaryAxis>

                        <chart:LineSeries x:Name="SeriesV"
                                          ItemsSource="{Binding ScopeV}"
                                          XBindingPath="Index"
                                          YBindingPath="Value"
                                          Label="Voltage"/>
                        <chart:LineSeries x:Name="SeriesI"
                                          ItemsSource="{Binding ScopeI}"
                                          XBindingPath="Index"
                                          YBindingPath="Value"
                                          Label="Current"/>
                    </chart:SfChart>
                </Grid>
            </TabItem>

            <!-- Harmonics -->
            <TabItem Header="Harmonics">
                <Grid Margin="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel>
                        <Button Content="Measure Harmonics" Click="BtnMeasureHarmonics_Click" Margin="0,0,12,0"/>
                        <Label Content="Up to N:" VerticalAlignment="Center"/>
                        <TextBox x:Name="TxtHarmonicsN" Width="60" Text="50" Margin="6,0,0,0"/>
                    </WrapPanel>

                    <chart:SfChart x:Name="HarmonicsChart" Grid.Row="1">
                        <chart:SfChart.PrimaryAxis>
                            <chart:CategoryAxis Header="Harmonic n"/>
                        </chart:SfChart.PrimaryAxis>
                        <chart:SfChart.SecondaryAxis>
                            <chart:NumericalAxis Header="Amplitude (norm)"/>
                        </chart:SfChart.SecondaryAxis>

                        <chart:ColumnSeries x:Name="SeriesHarm"
                                            ItemsSource="{Binding Harmonics}"
                                            XBindingPath="Index"
                                            YBindingPath="Value"
                                            Label="V Harmonics"/>
                    </chart:SfChart>
                </Grid>
            </TabItem>

            <!-- Sequence -->
            <TabItem Header="Sequence">
                <DockPanel Margin="6">
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top">
                        <Button Content="Add Step" Click="BtnAddStep_Click" Margin="0,0,6,0"/>
                        <Button Content="Delete Step" Click="BtnDeleteStep_Click" Margin="0,0,6,0"/>
                        <Button Content="Load JSON" Click="BtnLoadSeq_Click" Margin="0,0,6,0"/>
                        <Button Content="Save JSON" Click="BtnSaveSeq_Click" Margin="0,0,6,0"/>
                        <Button Content="Preflight" Click="BtnPreflight_Click" Margin="0,0,6,0"/>
                        <Button Content="Run" Click="BtnRunSeq_Click" Margin="0,0,12,0"/>
                        <CheckBox x:Name="ChkLoopSeq" Content="Loop"/>
                    </StackPanel>

                    <DataGrid x:Name="GridSteps" AutoGenerateColumns="False" CanUserAddRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Index}" IsReadOnly="True" Width="40"/>
                            <DataGridTextColumn Header="Duration(ms)" Binding="{Binding DurationMs}" Width="100"/>
                            <DataGridComboBoxColumn Header="AC/DC" SelectedItemBinding="{Binding AcDc}" Width="80"
                                                    ItemsSource="{StaticResource AcDcOptions}"/>
                            <DataGridComboBoxColumn Header="Func" SelectedItemBinding="{Binding Function}" Width="120"
                                                    ItemsSource="{StaticResource FuncOptions}"/>
                            <DataGridTextColumn Header="Setpoint" Binding="{Binding Setpoint}" Width="90"/>
                            <DataGridTextColumn Header="PF" Binding="{Binding Pf}" Width="70"/>
                            <DataGridTextColumn Header="CF" Binding="{Binding Cf}" Width="70"/>
                            <DataGridTextColumn Header="Repeat" Binding="{Binding Repeat}" Width="70"/>
                            <DataGridTextColumn Header="Note" Binding="{Binding Note}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </TabItem>

            <!-- Logger -->
            <TabItem Header="Logger">
                <DockPanel Margin="6">
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top">
                        <Button Content="Open Log Folder" Click="BtnOpenLogFolder_Click" Margin="0,0,12,0"/>
                        <TextBlock Text="Latest:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock x:Name="TxtLogPath" VerticalAlignment="Center"/>
                    </StackPanel>

                    <ListBox x:Name="ListLog"
                             VirtualizingStackPanel.IsVirtualizing="True"
                             VirtualizingStackPanel.VirtualizationMode="Recycling"
                             ScrollViewer.CanContentScroll="True"/>
                </DockPanel>
            </TabItem>
        </TabControl>

        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock x:Name="TxtStatus" Text="Idle"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>
