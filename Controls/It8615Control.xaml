<!-- It8615Control.xaml -->
<UserControl x:Class="HouseholdMS.Controls.It8615Control"  
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
             mc:Ignorable="d" d:DesignHeight="900" d:DesignWidth="1300">

    <UserControl.Resources>
        <x:Array x:Key="AcDcOptions" Type="{x:Type sys:String}">
            <sys:String>AC</sys:String>
            <sys:String>DC</sys:String>
        </x:Array>

        <!-- Keep it conservative for older SfChart versions -->
        <Style x:Key="MeterYAxisStyle" TargetType="syncfusion:NumericalAxis">
            <Setter Property="LabelFormat" Value="0.00"/>
            <Setter Property="OpposedPosition" Value="True"/>
            <Setter Property="ShowGridLines" Value="True"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top bar -->
        <DockPanel Margin="8">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <Label Content="Resource:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <ComboBox x:Name="ResourceCombo" Width="320" Margin="0,0,6,0"/>
                <Button x:Name="BtnRefresh" Content="Discover" Click="BtnRefresh_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnConnect" Content="Connect" Click="BtnConnect_Click" Margin="0,0,6,0"/>
                <Button x:Name="BtnDisconnect" Content="Disconnect" Click="BtnDisconnect_Click"/>
                <TextBlock Text="   Instrument ID:" VerticalAlignment="Center" Margin="12,0,4,0"/>
                <TextBlock x:Name="TxtIdn" FontWeight="Bold" VerticalAlignment="Center"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <TextBlock Text="Timeout (milliseconds)" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtTimeout" Width="80" Text="2000" Margin="0,0,10,0"/>
                <TextBlock Text="Retry Count" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox x:Name="TxtRetries" Width="50" Text="2"/>
            </StackPanel>
        </DockPanel>

        <!-- Body -->
        <TabControl Grid.Row="1" x:Name="MainTabs">
            <!-- Parameters -->
            <TabItem Header="Parameters">
                <ScrollViewer>
                    <Grid Margin="10">
                        <!-- two columns only: left stack (Operating) + Meter -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="3*"/>
                        </Grid.ColumnDefinitions>

                        <!-- LEFT COLUMN: stack -->
                        <StackPanel Grid.Column="0">
                            <GroupBox Header="Operating Mode" Margin="4">
                                <StackPanel Margin="8">
                                    <WrapPanel>
                                        <Label Content="AC / DC:"/>
                                        <ComboBox x:Name="CboAcDc" Width="100" Margin="6,0,12,0"
                                                  ItemsSource="{StaticResource AcDcOptions}" SelectedIndex="0"/>
                                        <Label Content="Function:"/>
                                        <!-- Friendly text in Content; exact SCPI token in Tag -->
                                        <ComboBox x:Name="CboFunction" Width="200" Margin="6,0,0,0"
                                                  ToolTip="Modes: Constant Current, Constant Resistance, Constant Voltage, Constant Power, Short Circuit">
                                            <ComboBoxItem Content="Current (Constant Current)"    Tag="CURR"/>
                                            <ComboBoxItem Content="Resistance (Constant Resistance)" Tag="RES"/>
                                            <ComboBoxItem Content="Voltage (Constant Voltage)"    Tag="VOLT"/>
                                            <ComboBoxItem Content="Power (Constant Power)"        Tag="POW"/>
                                            <ComboBoxItem Content="Short Circuit"                 Tag="SHOR"/>
                                        </ComboBox>
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Label Content="Setpoint:"/>
                                        <TextBox x:Name="TxtSetpoint" Width="120" Text="1.000" Margin="6,0,6,0"/>
                                        <TextBlock x:Name="TxtSetpointUnits" Text="A" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                        <Button x:Name="BtnApplySetpoint" Content="Apply" Margin="0,0,12,0" Click="BtnApplySetpoint_Click"/>
                                        <CheckBox x:Name="ChkEnable" Content="Enable Input" Click="ChkEnable_Click" />
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Label Content="Power Factor:"/>
                                        <TextBox x:Name="TxtPf" Width="80" Text="1.00" Margin="6,0,12,0"/>
                                        <Label Content="Crest Factor:"/>
                                        <TextBox x:Name="TxtCf" Width="80" Text="1.41" Margin="6,0,12,0"/>
                                        <Button x:Name="BtnApplyPfCf" Content="Apply Power Factor / Crest Factor" Click="BtnApplyPfCf_Click"/>
                                    </WrapPanel>

                                    <WrapPanel Margin="0,6,0,0">
                                        <Button x:Name="BtnStart" Content="Start" Width="120" Click="BtnStart_Click" Margin="0,0,6,0"/>
                                        <Button x:Name="BtnStop" Content="Stop" Width="120" Click="BtnStop_Click" Margin="0,0,6,0"/>
                                        <Button x:Name="BtnEStop" Content="Emergency Stop" Background="Tomato" Foreground="White" Click="BtnEStop_Click"/>
                                    </WrapPanel>

                                    <TextBlock x:Name="TxtLimits" TextWrapping="Wrap" Foreground="Gray" Margin="0,6,0,0"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <!-- RIGHT COLUMN: Meter panel with tiny charts -->
                        <GroupBox Header="Meter (Live)" Grid.Column="1" Margin="4">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="8">

                                    <!-- Voltage RMS -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Voltage RMS:"/>
                                            <TextBlock x:Name="ValVrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding VrmsHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Current RMS -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Current RMS:"/>
                                            <TextBlock x:Name="ValIrms" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding IrmsHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Power -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Power:"/>
                                            <TextBlock x:Name="ValPower" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding PowerHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Power Factor -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Power Factor:"/>
                                            <TextBlock x:Name="ValPf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}" LabelFormat="0.000"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding PfHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Frequency -->
                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Frequency:"/>
                                            <TextBlock x:Name="ValFreq" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding FreqHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>

                                    <!-- Crest Factor -->
                                    <StackPanel Margin="0,0,0,6">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Crest Factor:"/>
                                            <TextBlock x:Name="ValCf" FontSize="16" FontWeight="Bold" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <syncfusion:SfChart Height="90" Margin="0,4,0,0" Background="Transparent">
                                            <syncfusion:SfChart.PrimaryAxis>
                                                <syncfusion:NumericalAxis Visibility="Collapsed"/>
                                            </syncfusion:SfChart.PrimaryAxis>
                                            <syncfusion:SfChart.SecondaryAxis>
                                                <syncfusion:NumericalAxis Style="{StaticResource MeterYAxisStyle}"/>
                                            </syncfusion:SfChart.SecondaryAxis>
                                            <syncfusion:LineSeries EnableAnimation="False" StrokeThickness="1.2"
                                                                   ItemsSource="{Binding CfHistory}"
                                                                   XBindingPath="Index" YBindingPath="Value"/>
                                        </syncfusion:SfChart>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </GroupBox>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Scope -->
            <TabItem Header="Scope">
                <Grid Margin="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel>
                        <Button Content="Run" Click="BtnScopeRun_Click" Margin="0,0,6,0"/>
                        <Button Content="Single" Click="BtnScopeSingle_Click" Margin="0,0,6,0"/>
                        <Button Content="Stop" Click="BtnScopeStop_Click" Margin="0,0,12,0"/>
                        <Label Content="Trigger Source" VerticalAlignment="Center"/>
                        <ComboBox x:Name="CboTrigSource" Width="140" Margin="6,0,12,0">
                            <ComboBoxItem Content="Voltage" Tag="VOLTage"/>
                            <ComboBoxItem Content="Current" Tag="CURRent"/>
                        </ComboBox>
                        <Label Content="Trigger Slope" VerticalAlignment="Center"/>
                        <ComboBox x:Name="CboTrigSlope" Width="120" Margin="6,0,12,0">
                            <ComboBoxItem Content="Positive" Tag="POSitive"/>
                            <ComboBoxItem Content="Negative" Tag="NEGative"/>
                            <ComboBoxItem Content="Any"      Tag="ANY"/>
                        </ComboBox>
                        <Label Content="Trigger Level" VerticalAlignment="Center"/>
                        <TextBox x:Name="TxtTrigLevel" Width="80" Text="10" Margin="6,0,0,0"/>
                    </WrapPanel>

                    <!-- Big scope chart -->
                    <syncfusion:SfChart x:Name="ScopeChart" Grid.Row="1">
                        <syncfusion:SfChart.PrimaryAxis>
                            <syncfusion:NumericalAxis Header="Sample"/>
                        </syncfusion:SfChart.PrimaryAxis>
                        <syncfusion:SfChart.SecondaryAxis>
                            <syncfusion:NumericalAxis Header="V / A" LabelFormat="0.00"/>
                        </syncfusion:SfChart.SecondaryAxis>

                        <syncfusion:LineSeries x:Name="SeriesV"
                                               ItemsSource="{Binding ScopeV}"
                                               XBindingPath="Index"
                                               YBindingPath="Value"
                                               Label="Voltage"/>
                        <syncfusion:LineSeries x:Name="SeriesI"
                                               ItemsSource="{Binding ScopeI}"
                                               XBindingPath="Index"
                                               YBindingPath="Value"
                                               Label="Current"/>
                    </syncfusion:SfChart>
                </Grid>
            </TabItem>

            <!-- Harmonics -->
            <TabItem Header="Harmonics">
                <Grid Margin="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <WrapPanel>
                        <Button Content="Measure Harmonics" Click="BtnMeasureHarmonics_Click" Margin="0,0,12,0"/>
                        <Label Content="Up to Harmonic Number:" VerticalAlignment="Center"/>
                        <TextBox x:Name="TxtHarmonicsN" Width="60" Text="50" Margin="6,0,0,0"/>
                    </WrapPanel>

                    <syncfusion:SfChart x:Name="HarmonicsChart" Grid.Row="1">
                        <syncfusion:SfChart.PrimaryAxis>
                            <syncfusion:CategoryAxis Header="Harmonic Order (n)"/>
                        </syncfusion:SfChart.PrimaryAxis>
                        <syncfusion:SfChart.SecondaryAxis>
                            <syncfusion:NumericalAxis Header="Amplitude (normalized)" LabelFormat="0.00"/>
                        </syncfusion:SfChart.SecondaryAxis>

                        <syncfusion:ColumnSeries x:Name="SeriesHarm"
                                                 ItemsSource="{Binding Harmonics}"
                                                 XBindingPath="Index"
                                                 YBindingPath="Value"
                                                 Label="Voltage Harmonics"/>
                    </syncfusion:SfChart>
                </Grid>
            </TabItem>

            <!-- Logger -->
            <TabItem Header="Logger">
                <DockPanel Margin="6">
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top">
                        <Button Content="Open Log Folder" Click="BtnOpenLogFolder_Click" Margin="0,0,12,0"/>
                        <TextBlock Text="Latest Log:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock x:Name="TxtLogPath" VerticalAlignment="Center"/>
                    </StackPanel>

                    <ListBox x:Name="ListLog"
                             VirtualizingStackPanel.IsVirtualizing="True"
                             VirtualizingStackPanel.VirtualizationMode="Recycling"
                             ScrollViewer.CanContentScroll="True"/>
                </DockPanel>
            </TabItem>
        </TabControl>

        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock x:Name="TxtStatus" Text="Idle"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>
