<UserControl x:Class="HouseholdMS.View.Dashboard.ServiceCallDetailControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="440"
             Background="White">

    <UserControl.Resources>
        <!-- Palette -->
        <SolidColorBrush x:Key="Col.Accent" Color="#2563EB"/>
        <SolidColorBrush x:Key="Col.Success" Color="#16A34A"/>
        <SolidColorBrush x:Key="Col.Danger" Color="#DC2626"/>
        <SolidColorBrush x:Key="Col.Muted" Color="#6B7280"/>
        <SolidColorBrush x:Key="Col.Border" Color="#E5E7EB"/>
        <SolidColorBrush x:Key="Col.Card" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="Col.BadgeGreen" Color="#D1FAE5"/>
        <SolidColorBrush x:Key="Col.BadgeYellow" Color="#FEF3C7"/>
        <SolidColorBrush x:Key="Col.BadgeRed" Color="#FEE2E2"/>

        <!-- Labels -->
        <Style x:Key="FormLabel" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,12,0,6"/>
            <Setter Property="Foreground" Value="#111827"/>
        </Style>

        <!-- Inputs -->
        <Style x:Key="InputTextBox" TargetType="TextBox">
            <Setter Property="Height" Value="32"/>
            <Setter Property="Padding" Value="8,0"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="{StaticResource Col.Border}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Style.Triggers>
                <Trigger Property="IsKeyboardFocusWithin" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource Col.Accent}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Buttons -->
        <Style x:Key="PillButton" TargetType="Button">
            <Setter Property="Height" Value="36"/>
            <Setter Property="MinWidth" Value="110"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{StaticResource Col.Accent}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Opacity" Value="0.75"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButton" TargetType="Button" BasedOn="{StaticResource PillButton}">
            <Setter Property="Background" Value="{StaticResource Col.Success}"/>
        </Style>
        <Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource PillButton}">
            <Setter Property="Background" Value="{StaticResource Col.Danger}"/>
        </Style>

        <!-- Chip -->
        <Style x:Key="Chip" TargetType="Border">
            <Setter Property="CornerRadius" Value="999"/>
            <Setter Property="Background" Value="#F3F4F6"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Padding" Value="10,4"/>
        </Style>

        <!-- Card row for selected inventory -->
        <DataTemplate x:Key="InvCardTemplate">
            <Border Background="{StaticResource Col.Card}"
                    BorderBrush="{StaticResource Col.Border}"
                    BorderThickness="1"
                    CornerRadius="10"
                    Padding="10"
                    Margin="0,6,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Vertical" Grid.Column="0">
                        <TextBlock Text="{Binding ItemType}" FontWeight="SemiBold"/>
                        <Border CornerRadius="6"
                                Padding="6,2"
                                HorizontalAlignment="Left"
                                Margin="0,4,0,0"
                                Background="{Binding StockBadgeBrush}">
                            <TextBlock Text="{Binding StockBadgeText}" FontSize="12" Foreground="#111827"/>
                        </Border>
                    </StackPanel>

                    <!-- Quantity stepper -->
                    <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Center" Margin="10,0">
                        <Button Width="28" Height="28" Content="−" Click="QtyMinus_Click" Tag="{Binding}"/>
                        <TextBox Width="44" Height="28" Margin="6,0"
                                 HorizontalContentAlignment="Center"
                                 Text="{Binding QuantityUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <Button Width="28" Height="28" Content="+" Click="QtyPlus_Click" Tag="{Binding}"/>
                    </StackPanel>

                    <!-- Remove -->
                    <Button Grid.Column="2" Content="✕" Width="28" Height="28"
                            Background="#F3F4F6" Foreground="#374151"
                            BorderThickness="0" Margin="8,0,0,0"
                            Click="RemoveInv_Click" Tag="{Binding}"/>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Border Padding="25" CornerRadius="12" BorderBrush="{StaticResource Col.Border}" BorderThickness="1" Background="White">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                <TextBlock Text="🧰" FontSize="22" Margin="0,0,8,0"/>
                <TextBlock x:Name="HeaderText" Text="Service Call Details" FontSize="20" FontWeight="Bold" Foreground="#111827"/>
            </StackPanel>

            <!-- Body -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                <StackPanel>

                    <!-- Summary -->
                    <Border BorderBrush="{StaticResource Col.Border}" BorderThickness="1" CornerRadius="10" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="160"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Service ID:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="SvcIdText" Grid.Row="0" Grid.Column="1"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Opened At:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="OpenedAtText" Grid.Row="1" Grid.Column="1"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Household ID:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="HHIdText" Grid.Row="2" Grid.Column="1"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Owner:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="OwnerText" Grid.Row="3" Grid.Column="1"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="User:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="UserText" Grid.Row="4" Grid.Column="1"/>

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Municipality:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="MunicipalityText" Grid.Row="5" Grid.Column="1"/>

                            <TextBlock Grid.Row="6" Grid.Column="0" Text="District:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="DistrictText" Grid.Row="6" Grid.Column="1"/>

                            <TextBlock Grid.Row="7" Grid.Column="0" Text="Contact:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="ContactText" Grid.Row="7" Grid.Column="1"/>

                            <TextBlock Grid.Row="8" Grid.Column="0" Text="Current Status:" FontWeight="SemiBold"/>
                            <TextBlock x:Name="StatusText" Grid.Row="8" Grid.Column="1"/>
                        </Grid>
                    </Border>

                    <!-- Problem / Action -->
                    <TextBlock Text="Problem description" Style="{StaticResource FormLabel}"/>
                    <TextBox x:Name="ProblemBox" Height="90" AcceptsReturn="True" TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Auto" Style="{StaticResource InputTextBox}"/>

                    <TextBlock Text="Action taken" Style="{StaticResource FormLabel}"/>
                    <TextBox x:Name="ActionBox" Height="90" AcceptsReturn="True" TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Auto" Style="{StaticResource InputTextBox}"/>

                    <!-- Technicians -->
                    <TextBlock Text="Technicians involved" Style="{StaticResource FormLabel}"/>
                    <StackPanel Orientation="Vertical">
                        <Button x:Name="OpenTechPickerBtn"
                                Content="Select Technicians (0)"
                                Style="{StaticResource PillButton}"
                                Click="OpenTechPickerBtn_Click"/>
                        <ItemsControl x:Name="TechChipList" Margin="0,8,0,0">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource Chip}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" Margin="0,0,6,0"/>
                                            <Button Content="✕" Width="20" Height="20"
                                                    Background="#E5E7EB" Foreground="#374151"
                                                    BorderThickness="0" Padding="0"
                                                    Tag="{Binding}"
                                                    Click="RemoveTechChip_Click"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <!-- Inventory -->
                    <TextBlock Text="Inventory used" Style="{StaticResource FormLabel}"/>
                    <Button x:Name="OpenInvPickerBtn"
                            Content="Add Inventory Items"
                            Style="{StaticResource PillButton}"
                            Click="OpenInvPickerBtn_Click"/>
                    <ItemsControl x:Name="SelectedInvList" ItemTemplate="{StaticResource InvCardTemplate}" Margin="0,8,0,0"/>

                    <TextBlock x:Name="ValidationText"
                               Foreground="{StaticResource Col.Danger}"
                               Margin="0,8,0,0"
                               Visibility="Collapsed"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </ScrollViewer>

            <!-- Footer -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,18,0,0">
                <Button x:Name="FinishBtn" Content="✔ Finish Service" Style="{StaticResource PrimaryButton}" Click="FinishBtn_Click"/>
                <Button x:Name="CancelBtn" Content="✖ Cancel" Style="{StaticResource DangerButton}" Click="CancelBtn_Click"/>
            </StackPanel>

            <!-- ======= Overlays (in-panel modals) ======= -->
            <!-- Technicians Picker Overlay -->
            <Grid x:Name="TechOverlay" Background="#66000000" Visibility="Collapsed">
                <Border Background="White" CornerRadius="12" Padding="16" MaxWidth="520" HorizontalAlignment="Center" VerticalAlignment="Center" BorderBrush="{StaticResource Col.Border}" BorderThickness="1">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Select Technicians" FontSize="16" FontWeight="Bold"/>

                        <TextBox x:Name="TechSearchBox" Grid.Row="1" Margin="0,10,0,8" Style="{StaticResource InputTextBox}" PlaceholderText="Search..."
                                 TextChanged="TechSearchBox_TextChanged"/>

                        <ListBox x:Name="TechList" Grid.Row="2" BorderBrush="{StaticResource Col.Border}" BorderThickness="1" Height="320">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <DockPanel LastChildFill="True" Margin="6,4">
                                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                    </DockPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                            <Button Content="Save" Style="{StaticResource PrimaryButton}" Click="TechPickerSave_Click"/>
                            <Button Content="Close" Style="{StaticResource DangerButton}" Click="TechPickerClose_Click"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- Inventory Picker Overlay -->
            <Grid x:Name="InvOverlay" Background="#66000000" Visibility="Collapsed">
                <Border Background="White" CornerRadius="12" Padding="16" MaxWidth="680" HorizontalAlignment="Center" VerticalAlignment="Center" BorderBrush="{StaticResource Col.Border}" BorderThickness="1">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Add Inventory Items" FontSize="16" FontWeight="Bold"/>

                        <TextBox x:Name="InvSearchBox" Grid.Row="1" Margin="0,10,0,8" Style="{StaticResource InputTextBox}" PlaceholderText="Search items..."
                                 TextChanged="InvSearchBox_TextChanged"/>

                        <ListView x:Name="InvList" Grid.Row="2" BorderBrush="{StaticResource Col.Border}" BorderThickness="1" Height="360"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="Use" Width="60">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" HorizontalAlignment="Center"/>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Item" Width="220" DisplayMemberBinding="{Binding ItemType}"/>
                                    <GridViewColumn Header="Available" Width="100" DisplayMemberBinding="{Binding Available}"/>
                                    <GridViewColumn Header="Status" Width="120">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <Border Padding="6,2" CornerRadius="6" Background="{Binding StockBadgeBrush}" HorizontalAlignment="Left">
                                                    <TextBlock Text="{Binding StockBadgeText}" FontSize="12"/>
                                                </Border>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                    <GridViewColumn Header="Qty" Width="120">
                                        <GridViewColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <Button Width="24" Height="24" Content="−" Tag="{Binding}" Click="InvPickerMinus_Click"/>
                                                    <TextBox Width="40" Height="24" Margin="6,0"
                                                             HorizontalContentAlignment="Center"
                                                             Text="{Binding QuantityUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                                    <Button Width="24" Height="24" Content="+" Tag="{Binding}" Click="InvPickerPlus_Click"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </GridViewColumn.CellTemplate>
                                    </GridViewColumn>
                                </GridView>
                            </ListView.View>
                        </ListView>

                        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                            <Button Content="Add Selected" Style="{StaticResource PrimaryButton}" Click="InvPickerAdd_Click"/>
                            <Button Content="Close" Style="{StaticResource DangerButton}" Click="InvPickerClose_Click"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Border>
</UserControl>
